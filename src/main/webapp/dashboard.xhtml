<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:p="http://primefaces.org/ui" template="/WEB-INF/template.xhtml">
    <ui:define name="title">Dashboard</ui:define>
    <ui:define name="content">
        <style type="text/css">
            .green {
                background-color: #a5e594 !important;
                background-image: none !important;
                color: #11971f !important;
                padding: 15px;
                border-radius: 5px 5px 5px 5px;
                font-weight: bold;
            }

            .red {
                background-color: #e99989 !important;
                background-image: none !important;
                color: #922b21 !important;
                padding: 15px;
                border-radius: 5px 5px 5px 5px;
                font-weight: bold;
            }
        </style>
        <h:outputStylesheet>
            .item-con-linea:not(:first-child) {
                    border-top: 1px solid #ccc;
                    padding-top: 2rem;
                    margin-top: 2rem;
            }
            .planta-card {
                background-color: #c4c4c4 !important;
                border-left: 6px solid #00acc1;
                border-radius: 10px;
            }
            .camara-card {
                background-color: #6cdef4 !important;
                border-left: 6px solid #00acc1;
                border-radius: 10px;
            }
            @media screen and (max-width: 576px) {
                .planta-card {
                    margin-bottom: 1rem;
                }
                .camara-card {
                    font-size: 1.1rem;
                }
            }
        </h:outputStylesheet>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
        <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
        <script type="text/javascript">
            function charOcupacionCamaraExtender(){
                var options = {
                    options: {
                        plugins:{
                            title: {
                            display: false,
                            text: "title set from JavaScript"

                        },legend:{
                            display: true
                        },
                        datalabels:{
                            rotation: 90,
                            font: 'bold 20px sans-serif',
                            formatter: function(value, context) {
                                return value.toLocaleString('es-MX'); // 1200
                            }
                        }

                        }, scales:{
                            y: {
                                beginAtZero: true
                            }
                        }
                    },plugins: [ChartDataLabels]
                };

                //merge all options into to main chart options
                $.extend(true, this.cfg.config, options);
                };
            
            function charExtender() {
                var options = {
                    options: {
                        plugins:{
                            title: {
                            display: false,
                            text: "title set from JavaScript"

                        },legend:{
                            display: true
                        },
                        datalabels:{
                            rotation: 90,
                            font: 'bold 20px sans-serif',
                            formatter: function(value, context) {
                                return '$' + formatNumber(value); // 1200
                            }
                        }

                        }, scales:{
                            y: {
                                beginAtZero: true
                            }
                        }
                    },plugins: [ChartDataLabels]
                };

                //merge all options into to main chart options
                $.extend(true, this.cfg.config, options);
            };
            
            function formatNumber(value) {
                if (value >= 1_000_000) {
                    return (value / 1_000_000).toFixed(1).replace('.0','') + ' Millones';
                }
                if (value >= 1_000) {
                    return (value / 1_000).toFixed(1).replace('.0','') + ' Mil';
                }
                return value.toLocaleString('es-MX');
            }

            function charExtenderDonut() {
                var options = {
                    options: {
                        plugins: {
                            title: {
                                display: false,
                                text: "title set from JavaScript"

                            }, legend: {
                                display: true
                            },
                            datalabels: {
                                font: 'bold 16px sans-serif',
                                formatter: function (value, context) {
                                    return '$' + formatNumber(value); // 1200
                                }
                            }


                        }, scales: {

                            y: {
                                beginAtZero: false

                            }
                        }
                    }, plugins: [ChartDataLabels]
                };

                //merge all options into to main chart options
                $.extend(true, this.cfg.config, options);
            };

        </script>
        <h:form id="form">
            <p:panel header="Ocupación de cámaras" toggleable="true" >
                <ui:remove><p:barChart model="#{dashboardBean.modelCamara}" style="width: 100%; height: 400px;" /></ui:remove>
                <div class="p-grid ui-fluid" >
                    <p:repeat value="#{dashboardBean.plantas}" var="planta">
                        <div class="grid col-12 md:col-6 lg:col-4 p-2 flex justify-content-space-around" style="padding: .5rem;">
                            <p:card styleClass="planta-card" style="width: fit-content; margin: 0 auto;" >
                                <f:facet name="header">
                                    <h:panelGroup layout="block" style="font-weight: bold; font-size: 1.4rem; text-align: center; display: block;" >
                                        <h:outputText value="Planta #{planta}" />
                                        <i class="pi pi-building ml-2" style="margin-right: .5rem;"></i>
                                    </h:panelGroup>
                                </f:facet>
                                <div class="p-grid flex justify-content-center">
                                    <p:repeat value="#{dashboardBean.getCamaras(planta)}" var="camara">
                                        <div class="col-12 sm:col-6 md:col-4 lg:col-3 p-2" style="padding: .3rem;">
                                            <p:card styleClass="camara-card p-3 text-center" style="text-align: center; padding: .8rem;">
                                                <h:outputText value="Cámara #{camara.key}" style="font-weight: bold;" />
                                                <br/>
                                                <h:outputText value="#{camara.value}">
                                                    <f:convertNumber minFractionDigits="0" maxFractionDigits="2" />
                                                </h:outputText>
                                                <h:outputText value=" posiciones" />
                                            </p:card>
                                        </div>
                                    </p:repeat>
                                </div>
                            </p:card>
                        </div>
                    </p:repeat>
                </div>
            </p:panel>
			
        	<p:spacer style="height: 2rem;"/>
			
			<p:panel header="Estado de resultados" toggleable="true" rendered="#{(sideBarBean.usuario.perfil != 1) and (sideBarBean.usuario.perfil != 4)}">
				<p:barChart model="#{dashboardBean.stackedGroupBarModel}"/>
			</p:panel>
        	
        	<p:spacer style="height: 2rem;"/>
        	
        	<div class="p-grid ui-fluid">
            	<div class="p-col-12 p-md-9">
            		<p:panel header="Ventas por mes" toggleable="true" rendered="#{(sideBarBean.usuario.perfil != 1) and (sideBarBean.usuario.perfil != 4)}">
		            	<div class="p-grid ui-fluid">
		            		<div class="p-col-12 p-md-3">
		                        <p:datePicker id="yearMonth" view="month" value="#{dashboardBean.mesActual}" pattern="MM/yyyy" yearNavigator="true" 
		                            yearRange="2000:2050" maxdate="#{dashboardBean.maxDate}">
		                            <p:ajax listener="#{dashboardBean.VentaDia()}" update="dt-ventas @this" />
		                        </p:datePicker>
		            		</div>
		            		<div class="p-col-12 p-md-3">
		                        <p:commandButton value="Mostrar Detalle" styleClass="w-full md:w-auto" oncomplete="PF('dlgDesglose').show()" 
		                                     action="#{dashboardBean.readerList()}" process="form:yearMonth @this" update="form:dlg-Desglose form:yearMonth" />
		            		</div>
		            	</div>
		            	<p:spacer style="height: 1rem;"/>
		            	<div class="p-grid ui-fluid">
			                <p:dataTable id="dt-ventas" widgetVar="dtVentas" var="ventas" value="#{dashboardBean.listaVentaDia}" reflow="true" paginator="false"
			                             rowSelectMode="add" scrollable="true" scrollHeight="400" style="width:100%">
			
			                    <p:column headerText="Fecha" style="text-align:center; white-space:nowrap;">
			                        <h:outputText value="#{ventas.fecha}" />
			                    </p:column>
			
			                    <p:column headerText="Facturación al día" style="text-align:center">
			                        <h:outputText value="#{ventas.total_facturacion}">
			                            <f:convertNumber currencySymbol="$" type="currency" />
			                        </h:outputText>
			                    </p:column>
			
			                    <p:column headerText="Mes VS Mes" style="text-align:center">
			                        <h:outputText value="#{ventas.porcentaje} %" styleClass="#{(ventas.porcentaje ge 0 ? 'green' : (ventas.porcentaje lt 0 ? 'red' : null))}" />
			                    </p:column>
			
			                    <p:column headerText="Pendiente por cobrar (factura)" style="text-align:center">
			                        <h:outputText value="#{ventas.total_facturacion}">
			                            <f:convertNumber currencySymbol="$" type="currency" />
			                        </h:outputText>
			                    </p:column>
			
			                    <p:column headerText="Pendiente por cobrar (efectivo)" style="text-align:center">
                                                <h:outputText value="#{ventas.total_por_efectivo}" >
                                                    <f:convertNumber currencySymbol="$" type="currency" />
                                                </h:outputText>
			                    </p:column>
			
			                </p:dataTable>
		            	</div>
		                
		            </p:panel>
            	</div>
            	<div class="p-col-12 p-md-3">
            		<p:panel header="Ventas totales del mes" toggleable="true" rendered="#{(sideBarBean.usuario.perfil != 1) and (sideBarBean.usuario.perfil != 4)}">
		                <p:panel header="Ventas Totales" styleClass="text-center">
		                    <h:outputText value="#{dashboardBean.ventasGlobales.ventasTotales}">
		                        <f:convertNumber currencySymbol="$" type="currency" />
		                    </h:outputText>
		                </p:panel>
		                <p:spacer style="height: 1rem;"/>
		                <p:panel header="Ganancias" styleClass="text-center">
		                    <h:outputText value="#{dashboardBean.ventasGlobales.ganancias}">
		                        <f:convertNumber currencySymbol="$" type="currency" />
		                    </h:outputText>
		                </p:panel>
		                <p:spacer style="height: 1rem;"/>
		                <p:panel header="Porcentaje" styleClass="text-center">
		                    <h:outputText value="#{dashboardBean.ventasGlobales.porcentajeGanancias}">
		                        <f:convertNumber pattern="##0.00" />
		                    </h:outputText> %
		                </p:panel>
		            </p:panel>
            	</div>
            </div>
            
            <p:spacer style="height: 2rem;"/>
            
            <p:dialog id="dlg-Desglose" widgetVar="dlgDesglose" modal="true" responsive="true" style="max-width:95vw !important; width:95vw;" appendTo="@(body)" rendered="#{(sideBarBean.usuario.perfil != 1) and (sideBarBean.usuario.perfil != 4)}">
                <p:outputPanel style="overflow-x:auto;">
                    <p:dataTable id="dt-facturacionGeneral" widgetVar="dtFacturacion" var="ventas" value="#{dashboardBean.listaFacturacionGeneral}"
                                 reflow="true" paginator="true" rows="10" paginatorPosition="bottom" rowSelectMode="add" style="min-width:600px">

                        <p:column headerText="Fecha" style="text-align:center; white-space:nowrap;">
                            <h:outputText value="#{ventas.fecha}">
                                <f:convertDateTime pattern="dd/MM/yyyy"/>
                            </h:outputText>
                        </p:column>

                        <p:column headerText="Facturación al día" style="text-align:center">
                            <h:outputText value="#{ventas.total_facturacion}">
                                <f:convertNumber currencySymbol="$" type="currency" />
                            </h:outputText>
                        </p:column>

                        <p:column headerText="Mes VS Mes" style="text-align:center">
                            <h:outputText value="#{ventas.porcentaje} %"
                                          styleClass="#{(ventas.porcentaje ge 0 ? 'green' : (ventas.porcentaje lt 0 ? 'red' : null))}" />
                        </p:column>

                        <p:column headerText="Pendiente por cobrar (factura)" style="text-align:center">
                            <h:outputText value="#{ventas.total_facturacion}">
                                <f:convertNumber currencySymbol="$" type="currency" />
                            </h:outputText>
                        </p:column>

                        <p:column headerText="Pendiente por cobrar (efectivo)" style="text-align:center">
                            <h:outputText value="#{ventas.total_por_efectivo}">
                                <f:convertNumber currencySymbol="$" type="currency" />
                            </h:outputText>
                        </p:column>
                    </p:dataTable>
                </p:outputPanel>

                <f:facet name="footer">
                    <p:commandButton value="Cerrar" onclick="PF('dlgDesglose').hide();" styleClass="p-button-secondary"/>
                </f:facet>
            </p:dialog>
            
            <p:spacer style="height: 2rem;"/>
            
            <p:panel header="Ventas por mes" toggleable="true" rendered="#{(sideBarBean.usuario.perfil != 1) and (sideBarBean.usuario.perfil != 4)}">
                    <p:dataTable id="dt-ventasMes" widgetVar="dtVM" var="ventasM"
                                 value="#{dashboardBean.listaImporteGlobal}" reflow="true"
                                 style="width:100%;">

                        <p:column headerText="Mes" style="text-align:left; white-space:nowrap;">
                            <h:outputText value="#{ventasM.fecha}">
                                <f:convertDateTime pattern="MM/yyyy" />
                            </h:outputText>
                        </p:column>

                        <p:column headerText="Venta" style="text-align:center;">
                            <h:outputText value="#{ventasM.pagosPorMes}">
                                <f:convertNumber currencySymbol="$" type="currency" />
                            </h:outputText>
                        </p:column>
                    </p:dataTable>
            </p:panel>
            
            <p:spacer style="height: 2rem;"/>
            
            <div class="p-grid ui-fluid">
            	<div class="p-col-12 p-md-6">
            		<p:panel header="Ventas del mes por razón social" toggleable="true" rendered="#{(sideBarBean.usuario.perfil != 1) and (sideBarBean.usuario.perfil != 4)}">
            			<p:dataTable id="dt-ventaRS" widgetVar="dtVRS" var="ventaRS"
                                 value="#{dashboardBean.listaVentaRazonSocial}" reflow="true">
	
	                        <p:column headerText="Razón Social" style="text-align:left;">
	                            <h:outputText value="#{ventaRS.razonSocial}" />
	                        </p:column>
	
	                        <p:column headerText="Venta" style="text-align:right;" width="8rem">
	                            <h:outputText value="#{ventaRS.total_facturacion}">
	                                <f:convertNumber currencySymbol="$" type="currency" />
	                            </h:outputText>
	                        </p:column>
	                        <p:columnGroup type="footer">
	                        	<p:row>
	                        		<p:column colspan="1" style="text-align:left;" footerText="Total:"/>
	                        		<p:column style="text-align:right;">
	                        			<f:facet name="footer">
											<p:outputLabel value="#{dashboardBean.listaVentaRazonSocial.stream().map(item->item.total_facturacion).sum()}">
												<f:convertNumber pattern="$ #,###,##0.00" />
											</p:outputLabel>
	                        			</f:facet>
	                        		</p:column>
	                        	</p:row>
	                        </p:columnGroup>
	                    </p:dataTable>
            		</p:panel>
            	</div>
            	<div class="p-col-12 p-md-6">
            		<p:panel header="Ganancia por razón social" toggleable="true" rendered="#{(sideBarBean.usuario.perfil != 1) and (sideBarBean.usuario.perfil != 4)}">
                    	<p:dataTable id="dt-gananciaRS" widgetVar="dtGananciaRS" var="gananciaRS"
                                 value="#{dashboardBean.listaGananciaRazonSocial}" reflow="true">
	
	                        <p:column headerText="Razón Social" style="text-align:left;">
	                            <h:outputText value="#{gananciaRS.razonSocial}" />
	                        </p:column>
	
	                        <p:column headerText="Venta" style="text-align:right;" width="8rem">
	                            <h:outputText value="#{gananciaRS.total_facturacion}" >
	                                <f:convertNumber currencySymbol="$" type="currency" />
	                            </h:outputText>
	                        </p:column>
	                        <p:columnGroup type="footer">
	                        	<p:row>
	                        		<p:column colspan="1" style="text-align:left;" footerText="Total:"/>
	                        		<p:column style="text-align:right;">
	                        			<f:facet name="footer">
											<p:outputLabel value="#{dashboardBean.listaGananciaRazonSocial.stream().map(item->item.total_facturacion).sum()}">
												<f:convertNumber pattern="$ #,###,##0.00" />
											</p:outputLabel>
	                        			</f:facet>
	                        		</p:column>
	                        	</p:row>
	                        </p:columnGroup>
	                    </p:dataTable>
            		</p:panel>
            	</div>
            </div>
            
            <p:spacer style="height: 2rem;"/>
            
            <div class="p-grid ui-fluid">
            	<div class="p-col-12 p-md-6">
            		<p:panel header="Ventas" rendered="#{(sideBarBean.usuario.perfil != 1) and (sideBarBean.usuario.perfil != 4)}">
                    	<p:donutChart model="#{dashboardBean.donutModel}" style="width:100%; height:400px;" />
            		</p:panel>
            	</div>
            	<div class="p-col-12 p-md-6">
            		<p:panel header="Ingresos" rendered="#{(sideBarBean.usuario.perfil != 1) and (sideBarBean.usuario.perfil != 4)}">
						<p:barChart model="#{dashboardBean.smVentasFormaPago}" style="width:100%; height:400px;" />
            		</p:panel>
            	</div>
            </div>
        </h:form>
    </ui:define>

</ui:composition>