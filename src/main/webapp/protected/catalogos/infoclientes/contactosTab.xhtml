<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:f="http://xmlns.jcp.org/jsf/core" xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:p="http://primefaces.org/ui" xmlns:jsf="http://xmlns.jcp.org/jsf">

    <div>
        <p:commandButton id="contactoAdd" icon="pi pi-user-plus" value="Nuevo Contacto"
            actionListener="#{clientesBean.nuevoClienteContacto()}" process="@this" update="form:tabView:dialogContacto form:tabView:pnlContacto"
            oncomplete="PF('dialogContacto').show();" styleClass="ui-button-raised"
            style="margin-right: .5rem; width: auto;"
            disabled="#{clientesBean.clienteSelected == null}" />
    </div>

    <div class="orders-subtable">
        <p:dataTable id="dtContactos" widgetVar="dtContactos" var="clienteContacto"
            value="#{clientesBean.clienteSelected.clienteContactoList}" reflow="true"
            rowKey="#{contacto.idContacto.idContacto}" lazy="false" paginator="true" rows="5"
            paginatorPosition="bottom">

            <p:column headerText="Nombre" sortBy="#{contacto.idContacto.nbNombre}">
                <h:outputText value="#{clienteContacto.idContacto.nbNombre}" />
            </p:column>
            <p:column headerText="Primer apellido" sortBy="#{contacto.idContacto.nbApellido1}">
                <h:outputText value="#{clienteContacto.idContacto.nbApellido1}" />
            </p:column>
            <p:column headerText="Segundo apellido" sortBy="#{contacto.idContacto.nbApellido2}">
                <h:outputText value="#{clienteContacto.idContacto.nbApellido2}" />
            </p:column>
            <p:column width="2rem;" style="text-align:right;">
                <p:commandButton icon="pi pi-key" process="@this" update="form:tabView:pnlPassword"
                    oncomplete="PF('dlgPassword').show();">
                    <f:setPropertyActionListener value="#{clienteContacto}"
                        target="#{clientesBean.clienteContactoSelected}" />
                </p:commandButton>
            </p:column>
            <p:column width="2rem;" style="text-align:right;">
                <p:commandButton icon="pi pi-pencil" process="@this" oncomplete="PF('dialogContacto').show()"
                    update="form:tabView:dialogContacto form:tabView:pnlContacto">
                    <f:setPropertyActionListener value="#{clienteContacto}"
                        target="#{clientesBean.clienteContactoSelected}" />
                </p:commandButton>
            </p:column>
            <p:column width="2rem;" style="text-align:right;">
                <p:commandButton icon="pi pi-trash" styleClass="ui-button-danger" process="@this"
                    oncomplete="PF('deleteContactoDialog').show()">
                    <f:setPropertyActionListener value="#{clienteContacto}"
                        target="#{clientesBean.clienteContactoSelected}" />
                </p:commandButton>
            </p:column>
        </p:dataTable>
    </div>

    <p:dialog id="dialogContacto" widgetVar="dialogContacto" header="#{(clientesBean.clienteContactoSelected.id != null) ? 'Actualizar' : 'Agregar'} Contacto" showEffect="fade" modal="false"
        responsive="true" resizable="false" cache="false" style="max-width:80em !important;" dynamic="true">

        <p:outputPanel id="pnlContacto" class="ui-fluid">
            <p:scrollPanel mode="native" style="height: 500px; overflow:auto;">
                <div class="p-grid">
                    <div class="p-col-12 p-md-6 p-lg-4">
                        <div class="p-field">
                            <p:outputLabel>Nombre</p:outputLabel>
                            <p:inputText value="#{clientesBean.clienteContactoSelected.idContacto.nbNombre}" oninput="this.value = this.value.toUpperCase()"
                                required="true" requiredMessage="Debe indicar el nombre del contacto." />
                        </div>
                    </div>
                    <div class="p-col-12 p-md-6 p-lg-4">
                        <div class="p-field">
                            <p:outputLabel>Primer apellido</p:outputLabel>
                            <p:inputText value="#{clientesBean.clienteContactoSelected.idContacto.nbApellido1}" oninput="this.value = this.value.toUpperCase()"/>
                        </div>
                    </div>
                    <div class="p-col-12 p-md-6 p-lg-4">
                        <div class="p-field">
                            <p:outputLabel>Segundo apellido</p:outputLabel>
                            <p:inputText value="#{clientesBean.clienteContactoSelected.idContacto.nbApellido2}" oninput="this.value = this.value.toUpperCase()"/>
                        </div>
                    </div>
                    <div class="p-col-12 p-md-4 p-lg-4">
                        <div class="p-field">
                            <p:outputLabel>Usuario</p:outputLabel>
                            <p:inputText value="#{clientesBean.clienteContactoSelected.nbUsuario}" required="true"
                                requiredMessage="Debe indicar un usuario del módulo de clientes para el contacto." />
                        </div>
                    </div>
                    <div class="p-col-12 p-md-6 p-lg-4">
                        <div class="p-field">
                            <p:outputLabel>Estatus usuario</p:outputLabel>
                            <p:selectOneMenu value="#{clientesBean.clienteContactoSelected.stUsuario}">
                                <f:selectItem itemLabel="--Seleccione--" />
                                <f:selectItem itemLabel="Activo" itemValue="A" />
                                <f:selectItem itemLabel="#{clientesBean.editandoContacto ? 'Inactivo' : 'Baja'}"
                                    itemValue="#{clientesBean.editandoContacto ? 'I' : 'B'}" />
                                <f:selectItem itemLabel="Bloqueado" itemValue="L" />
                            </p:selectOneMenu>
                        </div>
                    </div>
                    <div class="p-col-12 p-md-6 p-lg-4">
                        <div class="p-field">
                            <p:outputLabel>Estatus</p:outputLabel>
                            <p:selectOneMenu value="#{clientesBean.clienteContactoSelected.stHabilitado}">
                                <f:selectItem itemLabel="--Seleccione--" />
                                <f:selectItem itemLabel="Activo" itemValue="true" />
                                <f:selectItem itemLabel="Inactivo" itemValue="false" />
                            </p:selectOneMenu>
                        </div>
                    </div>
                    <div class="p-col-12 p-md-6 p-lg-4">
                        <div class="p-field">
                            <p:outputLabel>¿Recibe correos de facturación?</p:outputLabel>
                            <p:toggleSwitch value="#{clientesBean.clienteContactoSelected.recibeFacturacion}" />
                        </div>
                    </div>
                    <div class="p-col-12 p-md-6 p-lg-4">
                        <div class="p-field">
                            <p:outputLabel>¿Recibe correos de inventario?</p:outputLabel>
                            <p:toggleSwitch value="#{clientesBean.clienteContactoSelected.recibeInventario}" />
                        </div>
                    </div>
                </div>

                <div>
                    <p:commandButton actionListener="#{clientesBean.nuevoMedioContacto()}" value="Nuevo medio contacto"
                        icon="pi pi-envelope" process="@this" resetValues="true" update="form:tabView:dialogMedioContacto form:tabView:pnlMedio"
                        oncomplete="PF('dialogMedioContacto').show()" styleClass="ui-button-raised"
                        style="margin-right: .5rem; width: auto;" />
                </div>

                <h:panelGroup>
                    <p:dataTable id="dtMedioContacto" lazy="false"
                        value="#{clientesBean.clienteContactoSelected.idContacto.medioCntList}" var="medio"
                        rowKey="#{medio.idMedio}" paginator="true" rows="5" paginatorPosition="bottom">

                        <p:column headerText="Tipo medio" width="10%">
                            <h:outputText
                                value="#{medio.tpMedio eq 'm' or medio.tpMedio eq 'M' ? 'MAIL' : 'TELÉFONO'}" />
                        </p:column>
                        <p:column headerText="Mail">
                            <h:outputText
                                value="#{medio.tpMedio eq 'm' or medio.tpMedio eq 'M' ? medio.idMail.nbMail : ''}" />
                        </p:column>
                        <p:column headerText="Tipo mail">
                            <h:outputText
                                value="#{medio.tpMedio eq 'm' or medio.tpMedio eq 'M' ? medio.idMail.tpMail.nbTipo : ''}" />
                        </p:column>
                        <p:column headerText="Teléfono">
                            <h:outputText
                                value="#{medio.tpMedio eq 't' or medio.tpMedio eq 'T' ? medio.idTelefono.nbTelefono : ''}" />
                        </p:column>
                        <p:column headerText="Tipo teléfono">
                            <h:outputText
                                value="#{medio.tpMedio eq 't' or medio.tpMedio eq 'T' ? medio.idTelefono.tpTelefono.nbTelefono : ''}" />
                        </p:column>
                        <p:column headerText="Estatus" width="10%">
                            <h:outputText value="#{medio.stMedio eq true ? 'ACTIVO' : 'INACTIVO'}" />
                        </p:column>
                        <p:column width="5%" style="text-align: right !important;">
                            <p:commandButton class="ui-button-primary" icon="pi pi-pencil" process="@this"
                                oncomplete="PF('dialogMedioContacto').show(); $('.ui-widget-overlay').remove();"
                                update="form:tabView:dialogMedioContacto form:tabView:pnlMedio">
                                <f:setPropertyActionListener value="#{medio}"
                                    target="#{clientesBean.medioCntSelected}" />
                            </p:commandButton>
                        </p:column>
                        <p:column width="5%" style="text-align: right !important;">
                            <p:commandButton class="ui-button-danger" icon="pi pi-trash" process="@this"
                                oncomplete="PF('deleteMedioContactoDialog').show(); $('.ui-widget-overlay').remove();"
                                update="dtMedioContacto">
                                <f:setPropertyActionListener value="#{medio}"
                                    target="#{clientesBean.medioCntSelected}" />
                            </p:commandButton>
                        </p:column>
                    </p:dataTable>
                </h:panelGroup>

            </p:scrollPanel>
        </p:outputPanel>

        <f:facet name="footer">
            <p:commandButton value="#{(clientesBean.clienteContactoSelected.id != null) ? 'Actualizar' : 'Agregar'}" icon="pi pi-check"
                actionListener="#{clientesBean.operarContactos('agregarcontacto')}" update="dtContactos"
                process="pnlContacto @this" oncomplete="PF('dialogContacto').hide();" />
            <p:commandButton value="Cancelar" icon="pi pi-times" oncomplete="PF('dialogContacto').hide()"
                immediate="true" class="ui-button-secondary" resetValues="true" />
        </f:facet>
    </p:dialog>


    <p:dialog id="dialogMedioContacto" widgetVar="dialogMedioContacto" header="#{(clientesBean.medioCntSelected.idMedio != null) ? 'Actualizar' : 'Agregar'} Medio de contacto" showEffect="fade"
        modal="false" responsive="true" dynamic="true">
        <p:outputPanel id="pnlMedio" class="ui-fluid">
            <p:outputPanel>
                <div class="p-field">
                    <p:outputLabel>Tipo de medio</p:outputLabel>
                    <p:selectOneMenu id="tpMedio" value="#{clientesBean.medioCntSelected.tpMedio}">
                        <p:ajax process="@this tpMedio" update="pnlMedio"
                            listener="#{clientesBean.seleccionarMedioContacto()}" />
                        <f:selectItem itemLabel="--Seleccione--" />
                        <!-- <f:selectItem itemLabel="Teléfono" itemValue="t" /> -->
                        <f:selectItem itemLabel="Mail" itemValue="m" />
                    </p:selectOneMenu>
                </div>
                <div class="p-field">
                    <p:outputLabel>Estatus</p:outputLabel>
                    <p:selectOneMenu id="soEstatusMedio" value="#{clientesBean.medioCntSelected.stMedio}"
                        required="true" requiredMessage="Campo requerido">
                        <f:selectItem itemLabel="Activo" itemValue="true" />
                        <f:selectItem itemLabel="Inactivo" itemValue="false" />
                        <p:ajax process="@this soEstatusMedio" />
                    </p:selectOneMenu>
                </div>
                <div class="p-field" jsf:rendered="#{clientesBean.medioCntSelected.tpMedio eq 'm'}">
                    <p:outputLabel>Tipo de mail</p:outputLabel>
                    <p:selectOneMenu value="#{clientesBean.medioCntSelected.idMail.tpMail}" converter="entityConverter">
                        <f:selectItem itemLabel="--Seleccione--" />
                        <f:selectItems value="#{clientesBean.lstTipoMail}" var="mail" itemLabel="#{mail.nbTipo}"
                            itemValue="#{mail}" />
                    </p:selectOneMenu>
                </div>
                <div class="p-field" jsf:rendered="#{clientesBean.medioCntSelected.tpMedio eq 't'}">
                    <p:outputLabel>Tipo de teléfono</p:outputLabel>
                    <p:selectOneMenu value="#{clientesBean.medioCntSelected.idTelefono.tpTelefono}"
                        converter="entityConverter">
                        <f:selectItem itemLabel="--Seleccione--" />
                        <f:selectItems value="#{clientesBean.lstTipoTelefono}" var="telefono"
                            itemLabel="#{telefono.nbTelefono}" itemValue="#{telefono}" />
                    </p:selectOneMenu>
                </div>
                <div class="p-field" jsf:rendered="#{clientesBean.medioCntSelected.tpMedio eq 't'}">
                    <p:outputLabel>Descripción</p:outputLabel>
                    <p:inputText value="#{clientesBean.medioCntSelected.idTelefono.nbTelefono}" required="true"
                        requiredMessage="Campo requerido" />
                </div>
                <div class="p-field" jsf:rendered="#{clientesBean.medioCntSelected.tpMedio eq 't'}">
                    <p:panelGrid columns="2" style="width:100%" styleClass="border-none">
                        <p:outputLabel>Principal</p:outputLabel>
                        <p:toggleSwitch value="#{clientesBean.medioCntSelected.idTelefono.stPrincipal}" />
                    </p:panelGrid>
                </div>
                <div class="p-field" jsf:rendered="#{clientesBean.medioCntSelected.tpMedio eq 'm'}">
                    <p:outputLabel>Descripción</p:outputLabel>
                    <p:inputText value="#{clientesBean.medioCntSelected.idMail.nbMail}" required="true"
                        requiredMessage="Campo requerido" />
                </div>
                <div class="p-field" jsf:rendered="#{clientesBean.medioCntSelected.tpMedio eq 'm'}">
                    <p:panelGrid columns="2" style="width:100%" styleClass="border-none">
                        <p:outputLabel>Principal</p:outputLabel>
                        <p:toggleSwitch value="#{clientesBean.medioCntSelected.idMail.stPrincipal}" />
                    </p:panelGrid>
                </div>
            </p:outputPanel>
        </p:outputPanel>
        <f:facet name="footer">
            <p:commandButton value="#{(clientesBean.medioCntSelected.idMedio != null) ? 'Actualizar' : 'Agregar'}" icon="pi pi-check" process="pnlMedio @this"
                actionListener="#{clientesBean.operarContactos('agregarmedio')}" update="form:tabView:dtMedioContacto"
                oncomplete="PF('dialogMedioContacto').hide()" />
            <p:commandButton value="Cancelar" icon="pi pi-times" oncomplete="PF('dialogMedioContacto').hide()"
                immediate="true" class="ui-button-secondary" resetValues="true" />
        </f:facet>
    </p:dialog>

    <p:dialog id="deleteContactoDialog" widgetVar="deleteContactoDialog" modal="false" closable="false"
        header="Eliminar" width="400" showEffect="fade" draggable="false" dynamic="true">

        <h:outputText value="¿Desea eliminar el contacto?" />

        <f:facet name="footer">
            <p:commandButton value="Sí" icon="pi pi-check"
                actionListener="#{clientesBean.operarContactos('eliminarcontacto')}"
                oncomplete="PF('deleteContactoDialog').hide()" update="dtContactos" process="@this" />

            <p:commandButton value="No" type="button" icon="pi pi-times" styleClass="ui-button-secondary"
                oncomplete="PF('deleteContactoDialog').hide()" immediate="true" />
        </f:facet>
    </p:dialog>

    <p:dialog id="deleteMedioContactoDialog" widgetVar="deleteMedioContactoDialog" modal="false" closable="false"
        header="Eliminar" width="400" showEffect="fade" draggable="false" dynamic="true">

        <h:outputText value="¿Desea eliminar el contacto?" />

        <f:facet name="footer">
            <p:commandButton value="Sí" icon="pi pi-check"
                actionListener="#{clientesBean.operarContactos('eliminarmedio')}"
                oncomplete="PF('deleteMedioContactoDialog').hide()" update="dtMedioContacto" process="@this" />

            <p:commandButton value="No" type="button" icon="pi pi-times" styleClass="ui-button-secondary"
                oncomplete="PF('deleteMedioContactoDialog').hide()" immediate="true" />
        </f:facet>
    </p:dialog>

    <p:dialog id="dlgPassword" header="Establecer contraseña" widgetVar="dlgPassword" showEffect="fade" modal="false"
        responsive="true">
        <p:outputPanel id="pnlPassword" class="ui-fluid">
            <div class="p-grid p-col-12">
                <p:panel>
                    <h5>Para cambiar su contraseña, debe considerar lo siguiente</h5>
                    <div>La contraseña debe tener entre 8 y 16 caracteres.</div>
                    <div>No debe tener espacios en blanco</div>
                    <div>Debe tener al menos una letra mayúscula</div>
                    <div>Debe tener al menos una letra minúscula</div>
                    <div>Debe tener al menos un número</div>
                    <div>Debe tener al menos un carácter especial: , . : * + - # $ % @ etc.</div>
                </p:panel>
            </div>
            <div class="card" align="center">
                <div class="field grid">
                    <p:outputLabel for="@next" value="Indique su nueva contraseña" styleClass="col-fixed" />
                    <div class="col">
                        <p:password id="newPassword" value="#{clientesBean.nuevaContrasenia}" toggleMask="true">
                        </p:password>
                    </div>
                </div>
                <div class="field grid">
                    <p:outputLabel for="@next" value="Confirme su nueva contraseña" styleClass="col-fixed" />
                    <div class="col">
                        <p:password id="confirmPassword" value="#{clientesBean.contraseniaConfirmacion}" toggleMask="true">
                        </p:password>
                    </div>
                </div>
            </div>
            <p:panel>
                <div class="card" align="center">
                    <p:commandButton id="change-password" value="Cambiar contraseña" icon="pi pi-check"
                                     actionListener="#{clientesBean.operarContactos('cambiarcontrasenia')}" process="@this pnlPassword" update="form:tabView:dtContactos" oncomplete="PF('dlgPassword').hide()"/>
                </div>
            </p:panel>
        </p:outputPanel>
    </p:dialog>

</ui:composition>